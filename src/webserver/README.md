# Web Server Package

This package provides a web server with both a modern web UI and REST API for viewing and managing Docker image analysis results. The server supports both viewing existing analysis results and triggering new image analysis operations.

## Features

- **Embedded Web Interface**: Modern, responsive web UI using Tailwind CSS, embedded in the binary
- **REST API**: Complete JSON API for programmatic access to image data and analysis operations
- **Live Image Analysis**: Trigger analysis of new Docker images via API endpoints
- **Asynchronous Operations**: Support for async image analysis with progress tracking
- **Auto-discovery**: Automatically finds and serves analysis results from the `tmp/` directory
- **Graceful Shutdown**: Handles SIGINT and SIGTERM for clean server shutdown
- **Request Logging**: All HTTP requests are logged with timing information

## API Endpoints

### GET /api/health
Returns server health status with build information.

**Response:**
```json
{
  "status": "healthy",
  "timestamp": "2025-07-21T14:47:10Z",
  "version": "v1.0.0",
  "git_commit": "a1b2c3d",
  "build_time": "2025-07-21T14:47:10Z",
  "go_version": "go1.24.2"
}
```

### GET /api/summaries
Returns a list of all available image summaries with metadata.

**Response:**
```json
[
  {
    "image_id": "sha256:7aab056cecc6...",
    "image_tag": "alpine:3.20",
    "image_source": "registry.example.com",
    "image_size": 7738912,
    "architecture": "amd64",
    "analyzed_at": "2025-07-21T14:47:10Z",
    "status": "completed",
    "request_id": "7aab056cecc6"
  }
]
```

### GET /api/info/{id}
Returns the full analysis data for a specific image by ID.

**Response:**
Complete JSON analysis file content, including filesystem analysis, layer information, environment variables, etc.

### DELETE /api/info/{id}
Removes a specific image analysis result and its associated files.

**Response:**
```json
{
  "success": true,
  "message": "Info 7aab056cecc6 deleted successfully"
}
```

### POST /api/analyze
Performs synchronous analysis of a Docker image (blocks until complete).

**Request:**
```json
{
  "image_name": "nginx:latest",
  "keep_temp_files": true,
  "force_pull": false
}
```

**Response:**
```json
{
  "success": true,
  "image_id": "7aab056cecc6",
  "message": "Image analysis completed successfully"
}
```

### POST /api/analyze-async
Starts asynchronous analysis of a Docker image (returns immediately with request ID).

**Request:**
```json
{
  "image_name": "nginx:latest",
  "keep_temp_files": true,
  "force_pull": false
}
```

**Response:**
```json
{
  "success": true,
  "request_id": "7aab056cecc6",
  "message": "Image analysis started"
}
```

## Configuration

The server is configured via the `Config` struct:

```go
type Config struct {
    Host    string // Host/IP address to bind to (default: "localhost")
    Port    string // Port number to listen on (default: "8080")
    WebRoot string // Custom web root directory (optional, uses embedded files if not specified)
}
```

## Architecture

The web server includes these key components:

- **Embedded Static Files**: Web UI files are embedded in the binary using Go's `embed` package
- **Request Logging**: All HTTP requests are logged with method, path, status code, and duration
- **Docker Client Integration**: Built-in Docker client for performing live image analysis
- **File System Management**: Automatic discovery and management of analysis result files
- **Graceful Shutdown**: Proper cleanup on SIGINT/SIGTERM signals

## Web Interface Features

The embedded web interface provides:

- **Modern UI**: Built with Tailwind CSS for responsive design
- **Image Gallery**: Visual cards showing analyzed images with key metadata
- **Detailed Analysis**: Modal dialogs with complete JSON analysis data
- **Live Analysis**: Forms to trigger new image analysis operations
- **Progress Tracking**: Real-time updates for asynchronous analysis operations
- **File Management**: Ability to delete analysis results through the UI

## File Discovery and Management

The server automatically manages analysis results by:

- **Auto-Discovery**: Scans the `tmp/` directory for `summary.*.json` files generated by analysis operations
- **Centralized Index**: Maintains a `summaries.json` file with metadata for all analyzed images
- **File Cleanup**: Provides API endpoints to delete analysis results and associated temporary files
- **Status Tracking**: Monitors analysis status ("completed", "analyzing", "failed") for each image

## Implementation Details

### Data Structures

- **ImageSummary**: Lightweight structure for listing images with essential metadata
- **AnalyzeRequest/Response**: Structures for synchronous analysis operations
- **AsyncAnalyzeRequest/Response**: Structures for asynchronous analysis with request tracking

### Docker Integration

The server integrates with the Docker SDK to:
- Validate image names and availability
- Perform live image analysis using the `analyzer` package
- Support both synchronous and asynchronous analysis workflows
- Handle Docker-specific errors and edge cases

### Error Handling

Comprehensive error handling includes:
- JSON parsing validation for API requests
- Docker client error propagation
- File system operation error handling
- HTTP status code mapping for different error types

## Security Considerations

- **Local Binding**: Server binds to localhost by default for security
- **No Authentication**: Intended for local development use; no authentication implemented
- **File Access Control**: Access restricted to configured web root and tmp directories
- **Path Traversal Protection**: Implemented for tar extraction and file operations
- **Input Validation**: All API endpoints validate request parameters and JSON payloads

## Development Notes

- The server uses Go's native `net/http` package with custom middleware for logging
- Static files are embedded using `//go:embed` for single-binary distribution
- Docker client operations are wrapped with proper error handling and timeouts
- The implementation follows Go best practices with clear separation of concerns
