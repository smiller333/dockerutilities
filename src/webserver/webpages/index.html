<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker Image Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-modal {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(2px);
        }
        
        .loading-modal .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100">
    <!-- Header -->
    <div class="bg-blue-600 text-white text-center py-4">
        <h1 id="pageTitle" class="text-2xl font-bold cursor-pointer hover:text-blue-200 transition-colors duration-200">Docker Image Viewer</h1>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto p-4 max-w-4xl">
        <!-- Analyze Image Section -->
        <div class="mb-6 bg-white shadow rounded-md p-4">
            <h3 class="text-lg font-medium mb-2 text-gray-800">Analyze Image</h3>
            <p class="text-sm text-gray-500 mb-2 italic">Note: If the image tag corresponds to an already analyzed ID, it will not be reprocessed.</p>
            <div class="flex items-center gap-2">
                <input
                    id="analyzeInput"
                    type="text"
                    placeholder="nginx:latest"
                    class="flex-1 p-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
                <button
                    id="analyzeBtn"
                    class="p-2 bg-gray-400 text-white rounded-md cursor-not-allowed opacity-50"
                    disabled
                >
                    Analyze
                </button>
            </div>
        </div>

        <!-- Analyzing Images Section -->
        <div id="analyzingSection" class="mb-6" style="display: none;">
            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                <h3 class="text-lg font-medium mb-3 text-yellow-800">
                    Images Being Analyzed
                </h3>
                <div id="analyzingList" class="space-y-2">
                    <!-- Analyzing images will be populated here -->
                </div>
            </div>
        </div>

        <!-- Failed Images Section -->
        <div id="failedSection" class="mb-6" style="display: none;">
            <div class="bg-red-50 border border-red-200 rounded-md p-4">
                <h3 class="text-lg font-medium mb-3 text-red-800">
                    Failed Analyses
                </h3>
                <div id="failedList" class="space-y-2">
                    <!-- Failed images will be populated here -->
                </div>
            </div>
        </div>

        <h2 class="text-xl font-semibold mb-4 text-gray-800">Analyzed Images</h2>

        <!-- Filter Controls -->
        <div class="mb-4 flex flex-col gap-2">
            <input
                id="filterInput"
                type="text"
                placeholder="Filter by tag..."
                class="p-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
        </div>

        <!-- Content Area -->
        <div id="content">
            <div class="flex items-center justify-center py-8">
                <div class="loading-spinner"></div>
                <span class="ml-2 text-gray-600">Loading image summaries...</span>
            </div>
        </div>
    </div>

    <!-- Modal for detailed view -->
    <div id="detailModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-90vh overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b">
                <h2 id="modalTitle" class="text-xl font-semibold">Image Details</h2>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-4 max-h-96 overflow-y-auto">
                <pre id="jsonData" class="bg-gray-50 p-4 rounded text-sm overflow-x-auto"></pre>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal loading-modal">
        <div class="bg-white rounded-lg shadow-xl p-8 mx-4 text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Analyzing Image</h3>
            <p class="text-gray-600" id="loadingMessage">Please wait while we analyze the Docker image...</p>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex items-center justify-between p-4 border-b">
                <h2 id="confirmTitle" class="text-xl font-semibold">Confirm Action</h2>
                <button id="closeConfirmModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-4">
                <p id="confirmMessage" class="text-gray-600 mb-6"></p>
                <div class="flex justify-end gap-3">
                    <button id="confirmCancel" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-md transition-colors duration-200">
                        Cancel
                    </button>
                    <button id="confirmDelete" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md transition-colors duration-200">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex items-center justify-between p-4 border-b">
                <h2 id="resultTitle" class="text-xl font-semibold">Result</h2>
                <button id="closeResultModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-4">
                <div id="resultContent" class="flex items-center mb-4">
                    <div id="resultIcon" class="mr-3"></div>
                    <p id="resultMessage" class="text-gray-600"></p>
                </div>
                <div class="flex justify-end">
                    <button id="resultOk" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors duration-200">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Modal -->
    <div id="healthModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-90vh overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b">
                <h2 class="text-xl font-semibold">System Health</h2>
                <button id="closeHealthModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-4 max-h-96 overflow-y-auto">
                <div id="healthContent" class="space-y-4">
                    <div class="flex items-center justify-center py-8">
                        <div class="loading-spinner"></div>
                        <span class="ml-2 text-gray-600">Loading health information...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let summaries = [];
        let currentSortField = 'analyzed_at';
        let currentSortOrder = 'desc';
        let currentFilter = '';
        let refreshInterval = null;

        // DOM elements
        const content = document.getElementById('content');
        const modal = document.getElementById('detailModal');
        const modalTitle = document.getElementById('modalTitle');
        const jsonData = document.getElementById('jsonData');
        const closeModal = document.getElementById('closeModal');
        const filterInput = document.getElementById('filterInput');
        const analyzeInput = document.getElementById('analyzeInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loadingModal = document.getElementById('loadingModal');
        const loadingMessage = document.getElementById('loadingMessage');
        const analyzingSection = document.getElementById('analyzingSection');
        const analyzingList = document.getElementById('analyzingList');
        const failedSection = document.getElementById('failedSection');
        const failedList = document.getElementById('failedList');
        
        // Confirmation modal elements
        const confirmModal = document.getElementById('confirmModal');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const closeConfirmModal = document.getElementById('closeConfirmModal');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmDelete = document.getElementById('confirmDelete');
        
        // Result modal elements
        const resultModal = document.getElementById('resultModal');
        const resultTitle = document.getElementById('resultTitle');
        const resultMessage = document.getElementById('resultMessage');
        const resultIcon = document.getElementById('resultIcon');
        const closeResultModal = document.getElementById('closeResultModal');
        const resultOk = document.getElementById('resultOk');
        
        // Health modal elements
        const healthModal = document.getElementById('healthModal');
        const healthContent = document.getElementById('healthContent');
        const closeHealthModal = document.getElementById('closeHealthModal');
        const pageTitle = document.getElementById('pageTitle');
        
        // Store pending delete action
        let pendingDeleteAction = null;

        // Initialize the application
        async function init() {
            await loadSummaries();
            renderSummaries();
            setupEventListeners();
            startAutoRefresh();
        }

        // Start auto-refresh for pending analyses
        function startAutoRefresh() {
            // Clear any existing interval
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // Check if there are any analyzing images
            function hasAnalyzingImages() {
                return summaries.some(summary => summary.status === 'analyzing');
            }
            
            // Set up interval to refresh if there are analyzing images
            function checkAndRefresh() {
                if (hasAnalyzingImages()) {
                    loadSummaries().then(() => {
                        renderSummaries();
                        // Continue checking if there are still analyzing images
                        if (!hasAnalyzingImages()) {
                            clearInterval(refreshInterval);
                            refreshInterval = null;
                        }
                    }).catch(err => {
                        console.error('Auto-refresh failed:', err);
                    });
                } else {
                    // No analyzing images, stop auto-refresh
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
            }
            
            // Start auto-refresh if needed
            if (hasAnalyzingImages()) {
                refreshInterval = setInterval(checkAndRefresh, 5000); // Check every 5 seconds
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            filterInput.addEventListener('input', (e) => {
                currentFilter = e.target.value;
                renderSummaries();
            });

            analyzeInput.addEventListener('input', (e) => {
                const hasValue = e.target.value.trim().length > 0;
                analyzeBtn.disabled = !hasValue;
                if (hasValue) {
                    analyzeBtn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
                    analyzeBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                } else {
                    analyzeBtn.classList.add('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
                    analyzeBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                }
            });

            analyzeBtn.addEventListener('click', handleAnalyzeImage);

            analyzeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !analyzeBtn.disabled) {
                    handleAnalyzeImage();
                }
            });

            closeModal.addEventListener('click', () => {
                modal.classList.remove('show');
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });

            // Confirmation modal event listeners
            closeConfirmModal.addEventListener('click', () => {
                confirmModal.classList.remove('show');
                pendingDeleteAction = null;
            });

            confirmCancel.addEventListener('click', () => {
                confirmModal.classList.remove('show');
                pendingDeleteAction = null;
            });

            confirmDelete.addEventListener('click', () => {
                confirmModal.classList.remove('show');
                if (pendingDeleteAction) {
                    executeDelete(pendingDeleteAction.imageId, pendingDeleteAction.imageTag);
                    pendingDeleteAction = null;
                }
            });

            confirmModal.addEventListener('click', (e) => {
                if (e.target === confirmModal) {
                    confirmModal.classList.remove('show');
                    pendingDeleteAction = null;
                }
            });

            // Result modal event listeners
            closeResultModal.addEventListener('click', () => {
                resultModal.classList.remove('show');
            });

            resultOk.addEventListener('click', () => {
                resultModal.classList.remove('show');
            });

            resultModal.addEventListener('click', (e) => {
                if (e.target === resultModal) {
                    resultModal.classList.remove('show');
                }
            });

            // Health modal event listeners
            pageTitle.addEventListener('click', showHealthModal);
            
            closeHealthModal.addEventListener('click', () => {
                healthModal.classList.remove('show');
            });

            healthModal.addEventListener('click', (e) => {
                if (e.target === healthModal) {
                    healthModal.classList.remove('show');
                }
            });
        }

        // Handle analyze image functionality
        async function handleAnalyzeImage() {
            const imageTag = analyzeInput.value.trim();
            if (!imageTag) return;

            // Check if already exists or is being analyzed
            if (summaries.some(summary => summary.image_tag.toLowerCase() === imageTag.toLowerCase())) {
                const existingSummary = summaries.find(summary => summary.image_tag.toLowerCase() === imageTag.toLowerCase());
                if (existingSummary.status === 'analyzing') {
                    showResultModal('Analysis In Progress', 'This image is currently being analyzed. Please wait for it to complete.', 'error');
                } else {
                    showResultModal('Already Analyzed', 'This image tag has already been analyzed.', 'error');
                }
                return;
            }

            // Show loading modal briefly to indicate request is being sent
            loadingMessage.textContent = `Starting analysis for ${imageTag}...`;
            loadingModal.classList.add('show');

            try {
                const response = await fetch('/api/analyze-async', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image_name: imageTag,
                        keep_temp_files: false,
                        force_pull: false
                    })
                });

                const result = await response.json();

                // Hide loading modal
                loadingModal.classList.remove('show');

                if (result.success) {
                    // Clear the input
                    analyzeInput.value = '';
                    
                    // Reload summaries to show the new pending analysis
                    await loadSummaries();
                    renderSummaries();
                    
                    // Start auto-refresh to monitor the analysis progress
                    startAutoRefresh();
                    
                    // Show success message indicating analysis has started
                    showResultModal(
                        'Analysis Started', 
                        `Analysis has been started for "${imageTag}".`,
                        'success'
                    );
                } else {
                    showResultModal('Analysis Failed', result.error || 'Unknown error', 'error');
                }
            } catch (error) {
                // Hide loading modal before showing error
                loadingModal.classList.remove('show');
                showResultModal('Analysis Failed', error.message, 'error');
            }
        }

        // Handle delete info functionality
        async function deleteInfo(imageId, imageTag) {
            // Show confirmation modal instead of browser confirm
            confirmTitle.textContent = 'Delete Analysis';
            confirmMessage.textContent = `Are you sure you want to delete the analysis for "${imageTag}" (${imageId})?`;
            pendingDeleteAction = { imageId, imageTag };
            confirmModal.classList.add('show');
        }

        // Execute the actual delete operation
        async function executeDelete(imageId, imageTag) {
            try {
                const response = await fetch(`/api/info/${imageId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    // Reload summaries to reflect the deletion
                    await loadSummaries();
                    renderSummaries();
                    
                    // Restart auto-refresh if needed (in case there are still analyzing images)
                    startAutoRefresh();
                    
                    // Show success result modal
                    showResultModal('Success', `Successfully deleted analysis for "${imageTag}"`, 'success');
                } else {
                    showResultModal('Error', `Failed to delete analysis: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showResultModal('Error', `Failed to delete analysis: ${error.message}`, 'error');
            }
        }

        // Show result modal with success or error message
        function showResultModal(title, message, type) {
            resultTitle.textContent = title;
            resultMessage.textContent = message;
            
            // Set icon based on type
            if (type === 'success') {
                resultIcon.innerHTML = '<div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>';
            } else {
                resultIcon.innerHTML = '<div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></div>';
            }
            
            resultModal.classList.add('show');
        }

        // Show health modal with system information
        async function showHealthModal() {
            // Show the modal first with loading content
            healthModal.classList.add('show');
            
            // Reset content to loading state
            healthContent.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="loading-spinner"></div>
                    <span class="ml-2 text-gray-600">Loading health information...</span>
                </div>
            `;
            
            try {
                const response = await fetch('/api/health');
                const healthData = await response.json();
                
                // Display the health information
                displayHealthData(healthData);
            } catch (error) {
                healthContent.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-red-800 font-medium">Failed to load health information</h3>
                                <p class="text-red-600 text-sm">${error.message}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Display health data in a structured format
        function displayHealthData(data) {
            const statusIcon = data.status === 'healthy' 
                ? '<div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>'
                : '<div class="w-6 h-6 bg-yellow-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg></div>';

            const dockerStatusIcon = data.docker?.status === 'connected'
                ? '<div class="w-5 h-5 bg-green-100 rounded-full flex items-center justify-center"><svg class="w-3 h-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>'
                : '<div class="w-5 h-5 bg-red-100 rounded-full flex items-center justify-center"><svg class="w-3 h-3 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></div>';

            let dockerInfoHtml = '';
            if (data.docker?.info) {
                const info = data.docker.info;
                dockerInfoHtml = `
                    <div class="mt-3 grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">Containers Running:</span>
                            <span class="text-gray-600">${info.containers_running || 0}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Images:</span>
                            <span class="text-gray-600">${info.images || 0}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Server Version:</span>
                            <span class="text-gray-600">${info.server_version || 'Unknown'}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Architecture:</span>
                            <span class="text-gray-600">${info.architecture || 'Unknown'}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">OS Type:</span>
                            <span class="text-gray-600">${info.os_type || 'Unknown'}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">CPUs:</span>
                            <span class="text-gray-600">${info.cpu_count || 'Unknown'}</span>
                        </div>
                    </div>
                `;
            }

            let dockerVersionHtml = '';
            if (data.docker?.version) {
                const version = data.docker.version;
                dockerVersionHtml = `
                    <div class="mt-3 text-sm">
                        <div class="font-medium text-gray-700 mb-2">Docker Version Details:</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div><span class="font-medium">Version:</span> ${version.version || 'Unknown'}</div>
                            <div><span class="font-medium">API Version:</span> ${version.api_version || 'Unknown'}</div>
                            <div><span class="font-medium">Go Version:</span> ${version.go_version || 'Unknown'}</div>
                            <div><span class="font-medium">Git Commit:</span> ${version.git_commit || 'Unknown'}</div>
                        </div>
                    </div>
                `;
            }

            healthContent.innerHTML = `
                <div class="space-y-4">
                    <!-- Overall Status -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center mb-2">
                            ${statusIcon}
                            <h3 class="ml-3 text-lg font-medium text-gray-800">System Status: ${data.status.charAt(0).toUpperCase() + data.status.slice(1)}</h3>
                        </div>
                    </div>

                    <!-- Docker Status -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center mb-2">
                            ${dockerStatusIcon}
                            <h3 class="ml-3 text-lg font-medium text-gray-800">Docker Daemon: ${data.docker?.status === 'connected' ? 'Connected' : 'Disconnected'}</h3>
                        </div>
                        ${data.docker?.docker_host ? `<div class="text-sm text-gray-600 mb-2"><span class="font-medium">Docker Host:</span> ${data.docker.docker_host}</div>` : ''}
                        ${data.docker?.error ? `<div class="text-sm text-red-600 mb-2">${data.docker.error}</div>` : ''}
                        ${dockerInfoHtml}
                        ${dockerVersionHtml}
                    </div>
                </div>

                    <!-- Build Information -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="text-lg font-medium text-gray-800 mb-3">Build Information</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-700">Version:</span>
                                <span class="text-gray-600">${data.build?.version || 'Unknown'}</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Git Commit:</span>
                                <span class="text-gray-600 font-mono">${data.build?.git_commit || 'Unknown'}</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Build Time:</span>
                                <span class="text-gray-600">${data.build?.build_time && data.build.build_time !== 'unknown' ? new Date(data.build.build_time).toLocaleString() : 'Unknown'}</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Go Version:</span>
                                <span class="text-gray-600">${data.build?.go_version || 'Unknown'}</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Target OS:</span>
                                <span class="text-gray-600">${data.build?.goos || 'Unknown'}</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Architecture:</span>
                                <span class="text-gray-600">${data.build?.goarch || 'Unknown'}</span>
                            </div>
                        </div>
                    </div>
            `;
        }

        // Sort by field (called by clicking table headers)
        function sortBy(field) {
            if (currentSortField === field) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortOrder = 'asc';
            }
            renderSummaries();
        }

        // Load summaries from the API
        async function loadSummaries() {
            try {
                const response = await fetch('/api/summaries');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                summaries = await response.json();
            } catch (error) {
                showError(`Failed to load summaries: ${error.message}`);
            }
        }

        // Render summaries in the UI
        function renderSummaries() {
            // Separate analyzing, failed, and completed images
            const analyzingImages = summaries.filter(summary => summary.status === 'analyzing');
            const failedImages = summaries.filter(summary => summary.status === 'failed');
            const completedImages = summaries.filter(summary => summary.status !== 'analyzing' && summary.status !== 'failed');
            
            // Render analyzing images section
            renderAnalyzingImages(analyzingImages);
            
            // Render failed images section
            renderFailedImages(failedImages);
            
            // Render completed images section
            renderCompletedImages(completedImages);
        }

        // Render analyzing images in their own section
        function renderAnalyzingImages(analyzingImages) {
            if (analyzingImages.length === 0) {
                analyzingSection.style.display = 'none';
                return;
            }

            analyzingSection.style.display = 'block';
            
            const analyzingItems = analyzingImages.map(summary => `
                <div class="bg-white rounded-md p-3 border border-yellow-200">
                    <div class="w-full">
                        <div class="font-medium text-gray-900">${summary.image_tag || 'Unknown'}</div>
                        <div class="text-sm text-gray-500 mt-1">Started: ${new Date(summary.analyzed_at).toLocaleString()}</div>
                    </div>
                </div>
            `).join('');
            
            analyzingList.innerHTML = analyzingItems;
        }

        // Render failed images in their own section
        function renderFailedImages(failedImages) {
            if (failedImages.length === 0) {
                failedSection.style.display = 'none';
                return;
            }

            failedSection.style.display = 'block';
            
            const failedItems = failedImages.map(summary => {
                // For deletion, use the full identifier (request_id for failed images, or short image_id for completed ones)
                const deleteId = summary.image_id ? (summary.image_id.replace('sha256:', '').substring(0, 12)) : (summary.request_id || 'unknown');
                
                return `
                    <div class="bg-white rounded-md p-3 border border-red-200">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${summary.image_tag || 'Unknown'}</div>
                                <div class="text-sm text-gray-500 mt-1">Failed: ${new Date(summary.analyzed_at).toLocaleString()}</div>
                            </div>
                            <button 
                                onclick="deleteInfo('${deleteId}', '${summary.image_tag || 'Unknown'}')" 
                                class="bg-red-500 hover:bg-red-600 text-white p-2 rounded transition-colors duration-200 ml-3"
                                title="Delete this failed analysis"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            failedList.innerHTML = failedItems;
        }

        // Render completed images in the main section
        function renderCompletedImages(completedImages) {
            if (completedImages.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">No Completed Image Analyses</h2>
                        <p class="text-gray-600 mb-4">No completed Docker image analysis results were found.</p>
                        <p class="text-gray-600 mb-6">Use the "Analyze Image" section above to analyze a Docker image and create analysis results.</p>
                    </div>
                `;
                return;
            }

            const filteredAndSortedSummaries = getFilteredAndSortedCompletedSummaries(completedImages);

            if (filteredAndSortedSummaries.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">No Matching Images</h2>
                        <p class="text-gray-600">No completed images match your current filter criteria.</p>
                    </div>
                `;
                return;
            }

            const tableRows = filteredAndSortedSummaries.map(summary => createTableRow(summary)).join('');
            
            content.innerHTML = `
                <div class="bg-white shadow rounded-md overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer hover:text-gray-700" onclick="sortBy('image_tag')">
                                    Tag <span class="inline-block ml-1">↑↓</span>
                                </th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer hover:text-gray-700" onclick="sortBy('image_id')">
                                    ID <span class="inline-block ml-1">↑↓</span>
                                </th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer hover:text-gray-700" onclick="sortBy('image_size')">
                                    Size <span class="inline-block ml-1">↑↓</span>
                                </th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer hover:text-gray-700" onclick="sortBy('architecture')">
                                    Arch <span class="inline-block ml-1">↑↓</span>
                                </th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer hover:text-gray-700" onclick="sortBy('analyzed_at')">
                                    Last Analyzed <span class="inline-block ml-1">↑↓</span>
                                </th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        ${tableRows}
                    </table>
                </div>
            `;
        }

        // Get filtered and sorted summaries (only for completed images)
        function getFilteredAndSortedCompletedSummaries(completedImages) {
            return completedImages
                .filter(summary => 
                    summary.image_tag && summary.image_tag.toLowerCase().includes(currentFilter.toLowerCase())
                )
                .sort((a, b) => {
                    const fieldA = a[currentSortField];
                    const fieldB = b[currentSortField];
                    
                    if (currentSortField === 'image_size' || currentSortField === 'layer_count') {
                        const numA = Number(fieldA) || 0;
                        const numB = Number(fieldB) || 0;
                        return currentSortOrder === 'asc' ? numA - numB : numB - numA;
                    }
                    
                    const strA = String(fieldA || '').toLowerCase();
                    const strB = String(fieldB || '').toLowerCase();
                    return currentSortOrder === 'asc' 
                        ? strA.localeCompare(strB)
                        : strB.localeCompare(strA);
                });
        }

        // Legacy function - kept for compatibility but now delegates to the new function
        function getFilteredAndSortedSummaries() {
            const completedImages = summaries.filter(summary => summary.status !== 'analyzing' && summary.status !== 'failed');
            return getFilteredAndSortedCompletedSummaries(completedImages);
        }

        // Format file size
        function formatSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Create a table row HTML (for completed images only)
        function createTableRow(summary) {
            const imageSize = formatSize(summary.image_size);
            const analyzedAt = new Date(summary.analyzed_at).toLocaleString();
            const shortImageId = (summary.image_id || '').replace('sha256:', '').substring(0, 12);

            // All entries in this table are completed, so we can simplify
            const deleteButton = `
                <button 
                    onclick="event.stopPropagation(); deleteInfo('${shortImageId}', '${summary.image_tag || 'Unknown'}')" 
                    class="bg-red-500 hover:bg-red-600 text-white p-2 rounded transition-colors duration-200"
                    title="Delete this analysis"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            `;

            let rowHtml = `
                <tbody class="hover:bg-gray-50 transition-colors">
                    <tr class="cursor-pointer" onclick="showDetails('${shortImageId}')" title="Click to view detailed analysis">
                        <td class="px-4 py-2 text-sm text-gray-900">${summary.image_tag || 'Unknown'}</td>
                        <td class="px-4 py-2 text-sm text-gray-500">${shortImageId}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${imageSize}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${summary.architecture || 'Unknown'}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${analyzedAt}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">
                            ${deleteButton}
                        </td>
                    </tr>`;

            // Add source row if image_source is available
            if (summary.image_source) {
                rowHtml += `
                    <tr>
                        <td colspan="6" class="px-4 py-1 text-xs text-gray-400 italic border-t-0">Source: ${summary.image_source}</td>
                    </tr>`;
            }

            rowHtml += `</tbody>`;

            return rowHtml;
        }

        // Navigate to details page
        function showDetails(id) {
            window.location.href = `details.html?id=${id}`;
        }

        // Show error message
        function showError(message) {
            content.innerHTML = `
                <div class="text-center py-12">
                    <h2 class="text-xl font-semibold mb-4 text-red-600">Error</h2>
                    <p class="text-gray-600">${message}</p>
                </div>
            `;
        }

        // Format date to human readable format
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            try {
                return new Date(dateString).toISOString();
            } catch {
                return 'Unknown';
            }
        }

        // Start the application
        init();
    </script>
</body>
</html>
