<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker Image Viewer - Analysis Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="theme.css">
    <style>
        .loading-modal {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(2px);
        }
        
        .loading-modal .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100">
    <!-- Header -->
    <div class="header-secondary">
        <h1 class="text-2xl font-bold">Docker Image Viewer</h1>
    </div>

    <!-- Navigation -->
    <div class="nav-breadcrumb">
        <div class="container mx-auto px-4 py-2">
            <a href="index.html" class="text-blue-600 hover:text-blue-800 text-sm">‚Üê Back to Tools</a>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto p-4 max-w-4xl">

        <!-- Analyze Image Section -->
        <div class="mb-6 card">
            <div class="card-body">
                <h3 class="card-title">Analyze Image</h3>
                <p class="text-sm text-gray-500 mb-2 italic">Note: If the image tag corresponds to an already analyzed ID, it will not be reprocessed.</p>
                <div class="flex items-center gap-2">
                    <input
                        id="analyzeInput"
                        type="text"
                        placeholder="nginx:latest"
                        class="form-input flex-1"
                    />
                    <button
                        id="analyzeBtn"
                        class="btn btn-secondary"
                        disabled
                    >
                        Analyze
                    </button>
                </div>
            </div>
        </div>

        <!-- Analyzing Images Section -->
        <div id="analyzingSection" class="mb-6" style="display: none;">
            <div class="status-warning">
                <h3 class="text-lg font-medium mb-3 text-yellow-800">
                    Images Being Analyzed
                </h3>
                <div id="analyzingList" class="space-y-2">
                    <!-- Analyzing images will be populated here -->
                </div>
            </div>
        </div>

        <!-- Failed Images Section -->
        <div id="failedSection" class="mb-6" style="display: none;">
            <div class="status-error">
                <h3 class="text-lg font-medium mb-3 text-red-800">
                    Failed Analyses
                </h3>
                <div id="failedList" class="space-y-2">
                    <!-- Failed images will be populated here -->
                </div>
            </div>
        </div>

        <h2 class="text-xl font-semibold mb-4 text-gray-800">Analyzed Images</h2>

        <!-- Filter Controls -->
        <div class="mb-4 flex flex-col gap-2">
            <input
                id="filterInput"
                type="text"
                placeholder="Filter by tag..."
                class="form-input"
            />
        </div>

        <!-- Content Area -->
        <div id="content">
            <div class="flex items-center justify-center py-8">
                <div class="loading-spinner"></div>
                <span class="ml-2 text-gray-600">Loading image summaries...</span>
            </div>
        </div>
    </div>

    <!-- Modal for detailed view -->
    <div id="detailModal" class="modal">
        <div class="modal-content max-w-4xl">
            <div class="modal-header">
                <h2 id="modalTitle" class="modal-title">Image Details</h2>
                <button id="closeModal" class="modal-close">&times;</button>
            </div>
            <div class="modal-body max-h-96 overflow-y-auto">
                <pre id="jsonData" class="bg-gray-50 p-4 rounded text-sm overflow-x-auto"></pre>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal loading-modal">
        <div class="modal-content text-center">
            <div class="modal-body">
                <div class="loading-spinner mx-auto mb-4"></div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Analyzing Image</h3>
                <p class="text-gray-600" id="loadingMessage">Please wait while we analyze the Docker image...</p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="confirmTitle" class="modal-title">Confirm Action</h2>
                <button id="closeConfirmModal" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" class="text-gray-600 mb-6"></p>
            </div>
            <div class="modal-footer">
                <button id="confirmCancel" class="btn btn-secondary">
                    Cancel
                </button>
                <button id="confirmDelete" class="btn btn-danger">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="resultTitle" class="modal-title">Result</h2>
                <button id="closeResultModal" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="resultContent" class="flex items-center mb-4">
                    <div id="resultIcon" class="mr-3"></div>
                    <p id="resultMessage" class="text-gray-600"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="resultOk" class="btn btn-primary">
                    OK
                </button>
            </div>
        </div>
    </div>



    <script>
        let summaries = [];
        let currentSortField = 'analyzed_at';
        let currentSortOrder = 'desc';
        let currentFilter = '';
        let refreshInterval = null;

        // DOM elements
        const content = document.getElementById('content');
        const modal = document.getElementById('detailModal');
        const modalTitle = document.getElementById('modalTitle');
        const jsonData = document.getElementById('jsonData');
        const closeModal = document.getElementById('closeModal');
        const filterInput = document.getElementById('filterInput');
        const analyzeInput = document.getElementById('analyzeInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loadingModal = document.getElementById('loadingModal');
        const loadingMessage = document.getElementById('loadingMessage');
        const analyzingSection = document.getElementById('analyzingSection');
        const analyzingList = document.getElementById('analyzingList');
        const failedSection = document.getElementById('failedSection');
        const failedList = document.getElementById('failedList');
        
        // Confirmation modal elements
        const confirmModal = document.getElementById('confirmModal');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const closeConfirmModal = document.getElementById('closeConfirmModal');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmDelete = document.getElementById('confirmDelete');
        
        // Result modal elements
        const resultModal = document.getElementById('resultModal');
        const resultTitle = document.getElementById('resultTitle');
        const resultMessage = document.getElementById('resultMessage');
        const resultIcon = document.getElementById('resultIcon');
        const closeResultModal = document.getElementById('closeResultModal');
        const resultOk = document.getElementById('resultOk');
        

        
        // Store pending delete action
        let pendingDeleteAction = null;

        // Initialize the application
        async function init() {
            await loadSummaries();
            renderSummaries();
            setupEventListeners();
            startAutoRefresh();
        }

        // Start auto-refresh for pending analyses
        function startAutoRefresh() {
            // Clear any existing interval
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // Check if there are any analyzing images
            function hasAnalyzingImages() {
                return summaries.some(summary => summary.status === 'analyzing');
            }
            
            // Set up interval to refresh if there are analyzing images
            function checkAndRefresh() {
                if (hasAnalyzingImages()) {
                    loadSummaries().then(() => {
                        renderSummaries();
                        // Continue checking if there are still analyzing images
                        if (!hasAnalyzingImages()) {
                            clearInterval(refreshInterval);
                            refreshInterval = null;
                        }
                    }).catch(err => {
                        console.error('Auto-refresh failed:', err);
                    });
                } else {
                    // No analyzing images, stop auto-refresh
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
            }
            
            // Start auto-refresh if needed
            if (hasAnalyzingImages()) {
                refreshInterval = setInterval(checkAndRefresh, 5000); // Check every 5 seconds
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            filterInput.addEventListener('input', (e) => {
                currentFilter = e.target.value;
                renderSummaries();
            });

            analyzeInput.addEventListener('input', (e) => {
                const hasValue = e.target.value.trim().length > 0;
                analyzeBtn.disabled = !hasValue;
                if (hasValue) {
                    analyzeBtn.classList.remove('btn-secondary');
                    analyzeBtn.classList.add('btn-primary');
                } else {
                    analyzeBtn.classList.remove('btn-primary');
                    analyzeBtn.classList.add('btn-secondary');
                }
            });

            analyzeBtn.addEventListener('click', handleAnalyzeImage);

            analyzeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !analyzeBtn.disabled) {
                    handleAnalyzeImage();
                }
            });

            closeModal.addEventListener('click', () => {
                modal.classList.remove('show');
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });

            // Confirmation modal event listeners
            closeConfirmModal.addEventListener('click', () => {
                confirmModal.classList.remove('show');
                pendingDeleteAction = null;
            });

            confirmCancel.addEventListener('click', () => {
                confirmModal.classList.remove('show');
                pendingDeleteAction = null;
            });

            confirmDelete.addEventListener('click', () => {
                confirmModal.classList.remove('show');
                if (pendingDeleteAction) {
                    executeDelete(pendingDeleteAction.imageId, pendingDeleteAction.imageTag);
                    pendingDeleteAction = null;
                }
            });

            confirmModal.addEventListener('click', (e) => {
                if (e.target === confirmModal) {
                    confirmModal.classList.remove('show');
                    pendingDeleteAction = null;
                }
            });

            // Result modal event listeners
            closeResultModal.addEventListener('click', () => {
                resultModal.classList.remove('show');
            });

            resultOk.addEventListener('click', () => {
                resultModal.classList.remove('show');
            });

            resultModal.addEventListener('click', (e) => {
                if (e.target === resultModal) {
                    resultModal.classList.remove('show');
                }
            });


        }

        // Handle analyze image functionality
        async function handleAnalyzeImage() {
            const imageTag = analyzeInput.value.trim();
            if (!imageTag) return;

            // Check if already exists or is being analyzed
            if (summaries.some(summary => summary.image_tag.toLowerCase() === imageTag.toLowerCase())) {
                const existingSummary = summaries.find(summary => summary.image_tag.toLowerCase() === imageTag.toLowerCase());
                if (existingSummary.status === 'analyzing') {
                    showResultModal('Analysis In Progress', 'This image is currently being analyzed. Please wait for it to complete.', 'error');
                } else {
                    showResultModal('Already Analyzed', 'This image tag has already been analyzed.', 'error');
                }
                return;
            }

            // Show loading modal briefly to indicate request is being sent
            loadingMessage.textContent = `Starting analysis for ${imageTag}...`;
            loadingModal.classList.add('show');

            try {
                const response = await fetch('/api/analyze-async', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image_name: imageTag,
                        keep_temp_files: false,
                        force_pull: false
                    })
                });

                const result = await response.json();

                // Hide loading modal
                loadingModal.classList.remove('show');

                if (result.success) {
                    // Clear the input
                    analyzeInput.value = '';
                    
                    // Reload summaries to show the new pending analysis
                    await loadSummaries();
                    renderSummaries();
                    
                    // Start auto-refresh to monitor the analysis progress
                    startAutoRefresh();
                    
                    // Show success message indicating analysis has started
                    showResultModal(
                        'Analysis Started', 
                        `Analysis has been started for "${imageTag}".`,
                        'success'
                    );
                } else {
                    showResultModal('Analysis Failed', result.error || 'Unknown error', 'error');
                }
            } catch (error) {
                // Hide loading modal before showing error
                loadingModal.classList.remove('show');
                showResultModal('Analysis Failed', error.message, 'error');
            }
        }

        // Handle delete info functionality
        async function deleteInfo(imageId, imageTag) {
            // Show confirmation modal instead of browser confirm
            confirmTitle.textContent = 'Delete Analysis';
            confirmMessage.textContent = `Are you sure you want to delete the analysis for "${imageTag}" (${imageId})?`;
            pendingDeleteAction = { imageId, imageTag };
            confirmModal.classList.add('show');
        }

        // Execute the actual delete operation
        async function executeDelete(imageId, imageTag) {
            try {
                const response = await fetch(`/api/info/${imageId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    // Reload summaries to reflect the deletion
                    await loadSummaries();
                    renderSummaries();
                    
                    // Restart auto-refresh if needed (in case there are still analyzing images)
                    startAutoRefresh();
                    
                    // Show success result modal
                    showResultModal('Success', `Successfully deleted analysis for "${imageTag}"`, 'success');
                } else {
                    showResultModal('Error', `Failed to delete analysis: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showResultModal('Error', `Failed to delete analysis: ${error.message}`, 'error');
            }
        }

        // Show result modal with success or error message
        function showResultModal(title, message, type) {
            resultTitle.textContent = title;
            resultMessage.textContent = message;
            
            // Set icon based on type
            if (type === 'success') {
                resultIcon.innerHTML = '<div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>';
            } else {
                resultIcon.innerHTML = '<div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></div>';
            }
            
            resultModal.classList.add('show');
        }



        // Sort by field (called by clicking table headers)
        function sortBy(field) {
            if (currentSortField === field) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortOrder = 'asc';
            }
            renderSummaries();
        }

        // Load summaries from the API
        async function loadSummaries() {
            try {
                const response = await fetch('/api/summaries');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                summaries = await response.json();
            } catch (error) {
                showError(`Failed to load summaries: ${error.message}`);
            }
        }

        // Render summaries in the UI
        function renderSummaries() {
            // Separate analyzing, failed, and completed images
            const analyzingImages = summaries.filter(summary => summary.status === 'analyzing');
            const failedImages = summaries.filter(summary => summary.status === 'failed');
            const completedImages = summaries.filter(summary => summary.status !== 'analyzing' && summary.status !== 'failed');
            
            // Render analyzing images section
            renderAnalyzingImages(analyzingImages);
            
            // Render failed images section
            renderFailedImages(failedImages);
            
            // Render completed images section
            renderCompletedImages(completedImages);
        }

        // Render analyzing images in their own section
        function renderAnalyzingImages(analyzingImages) {
            if (analyzingImages.length === 0) {
                analyzingSection.style.display = 'none';
                return;
            }

            analyzingSection.style.display = 'block';
            
            const analyzingItems = analyzingImages.map(summary => `
                <div class="bg-white rounded-md p-3 border border-yellow-200">
                    <div class="w-full">
                        <div class="font-medium text-gray-900">${summary.image_tag || 'Unknown'}</div>
                        <div class="text-sm text-gray-500 mt-1">Started: ${new Date(summary.analyzed_at).toLocaleString()}</div>
                    </div>
                </div>
            `).join('');
            
            analyzingList.innerHTML = analyzingItems;
        }

        // Render failed images in their own section
        function renderFailedImages(failedImages) {
            if (failedImages.length === 0) {
                failedSection.style.display = 'none';
                return;
            }

            failedSection.style.display = 'block';
            
            const failedItems = failedImages.map(summary => {
                // For deletion, use the full identifier (request_id for failed images, or short image_id for completed ones)
                const deleteId = summary.image_id ? (summary.image_id.replace('sha256:', '').substring(0, 12)) : (summary.request_id || 'unknown');
                
                return `
                    <div class="bg-white rounded-md p-3 border border-red-200">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${summary.image_tag || 'Unknown'}</div>
                                <div class="text-sm text-gray-500 mt-1">Failed: ${new Date(summary.analyzed_at).toLocaleString()}</div>
                            </div>
                            <button 
                                onclick="deleteInfo('${deleteId}', '${summary.image_tag || 'Unknown'}')" 
                                class="bg-red-500 hover:bg-red-600 text-white p-2 rounded transition-colors duration-200 ml-3"
                                title="Delete this failed analysis"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            failedList.innerHTML = failedItems;
        }

        // Render completed images in the main section
        function renderCompletedImages(completedImages) {
            if (completedImages.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">No Completed Image Analyses</h2>
                        <p class="text-gray-600 mb-4">No completed Docker image analysis results were found.</p>
                        <p class="text-gray-600 mb-6">Use the "Analyze Image" section above to analyze a Docker image and create analysis results.</p>
                    </div>
                `;
                return;
            }

            const filteredAndSortedSummaries = getFilteredAndSortedCompletedSummaries(completedImages);

            if (filteredAndSortedSummaries.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">No Matching Images</h2>
                        <p class="text-gray-600">No completed images match your current filter criteria.</p>
                    </div>
                `;
                return;
            }

            const tableRows = filteredAndSortedSummaries.map(summary => createTableRow(summary)).join('');
            
            content.innerHTML = `
                <div class="card overflow-hidden">
                    <table class="table">
                        <thead>
                            <tr>
                                <th onclick="sortBy('image_tag')">
                                    Tag <span class="inline-block ml-1">‚Üë‚Üì</span>
                                </th>
                                <th onclick="sortBy('image_id')">
                                    ID <span class="inline-block ml-1">‚Üë‚Üì</span>
                                </th>
                                <th onclick="sortBy('image_size')">
                                    Size <span class="inline-block ml-1">‚Üë‚Üì</span>
                                </th>
                                <th onclick="sortBy('architecture')">
                                    Arch <span class="inline-block ml-1">‚Üë‚Üì</span>
                                </th>
                                <th onclick="sortBy('analyzed_at')">
                                    Last Analyzed <span class="inline-block ml-1">‚Üë‚Üì</span>
                                </th>
                                <th>
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        ${tableRows}
                    </table>
                </div>
            `;
        }

        // Get filtered and sorted summaries (only for completed images)
        function getFilteredAndSortedCompletedSummaries(completedImages) {
            return completedImages
                .filter(summary => 
                    summary.image_tag && summary.image_tag.toLowerCase().includes(currentFilter.toLowerCase())
                )
                .sort((a, b) => {
                    const fieldA = a[currentSortField];
                    const fieldB = b[currentSortField];
                    
                    if (currentSortField === 'image_size' || currentSortField === 'layer_count') {
                        const numA = Number(fieldA) || 0;
                        const numB = Number(fieldB) || 0;
                        return currentSortOrder === 'asc' ? numA - numB : numB - numA;
                    }
                    
                    const strA = String(fieldA || '').toLowerCase();
                    const strB = String(fieldB || '').toLowerCase();
                    return currentSortOrder === 'asc' 
                        ? strA.localeCompare(strB)
                        : strB.localeCompare(strA);
                });
        }

        // Legacy function - kept for compatibility but now delegates to the new function
        function getFilteredAndSortedSummaries() {
            const completedImages = summaries.filter(summary => summary.status !== 'analyzing' && summary.status !== 'failed');
            return getFilteredAndSortedCompletedSummaries(completedImages);
        }

        // Format file size
        function formatSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Create a table row HTML (for completed images only)
        function createTableRow(summary) {
            const imageSize = formatSize(summary.image_size);
            const analyzedAt = new Date(summary.analyzed_at).toLocaleString();
            const shortImageId = (summary.image_id || '').replace('sha256:', '').substring(0, 12);

            // All entries in this table are completed, so we can simplify
            const deleteButton = `
                <button 
                    onclick="event.stopPropagation(); deleteInfo('${shortImageId}', '${summary.image_tag || 'Unknown'}')" 
                    class="btn btn-danger btn-sm"
                    title="Delete this analysis"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            `;

            let rowHtml = `
                <tbody>
                    <tr class="clickable" onclick="showDetails('${shortImageId}')" title="Click to view detailed analysis">
                        <td>${summary.image_tag || 'Unknown'}</td>
                        <td>${shortImageId}</td>
                        <td>${imageSize}</td>
                        <td>${summary.architecture || 'Unknown'}</td>
                        <td>${analyzedAt}</td>
                        <td>
                            ${deleteButton}
                        </td>
                    </tr>`;

            // Add source row if image_source is available
            if (summary.image_source) {
                rowHtml += `
                    <tr>
                        <td colspan="6" class="text-xs text-gray-400 italic border-t-0">Source: ${summary.image_source}</td>
                    </tr>`;
            }

            rowHtml += `</tbody>`;

            return rowHtml;
        }

        // Navigate to details page
        function showDetails(id) {
            window.location.href = `imagedetails.html?id=${id}`;
        }

        // Show error message
        function showError(message) {
            content.innerHTML = `
                <div class="text-center py-12">
                    <h2 class="text-xl font-semibold mb-4 text-red-600">Error</h2>
                    <p class="text-gray-600">${message}</p>
                </div>
            `;
        }

        // Format date to human readable format
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            try {
                return new Date(dateString).toISOString();
            } catch {
                return 'Unknown';
            }
        }

        // Start the application
        init();
    </script>
</body>
</html>
