name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for GoReleaser
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24.2'
        cache: true
    
    - name: Validate GoReleaser configuration
      run: |
        echo "Validating GoReleaser configuration..."
        goreleaser check
        echo "Configuration is valid!"
    
    - name: Run tests before release
      run: |
        echo "Running comprehensive tests..."
        go test -v -race -coverprofile=coverage.out ./...
        go vet ./...
        echo "Tests completed successfully!"
    
    - name: Build and test locally (dry run)
      run: |
        echo "Testing GoReleaser build process..."
        goreleaser build --snapshot --clean --parallelism=2
        echo "Local build test completed!"
    
    - name: Run GoReleaser
      uses: goreleaser/goreleaser-action@v5
      with:
        distribution: goreleaser
        version: latest
        args: release --clean --parallelism=2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Enhanced artifact verification
      run: |
        echo "üîç Enhanced artifact verification..."
        
        # Check if release was created
        if [ -f "dist/checksums.txt" ]; then
          echo "‚úÖ Checksums file created"
          echo "Checksums content:"
          cat dist/checksums.txt
        else
          echo "‚ùå Checksums file not found"
          exit 1
        fi
        
        # Verify checksums
        echo "üîê Verifying checksums..."
        cd dist
        if sha256sum -c checksums.txt; then
          echo "‚úÖ All checksums verified successfully"
        else
          echo "‚ùå Checksum verification failed"
          exit 1
        fi
        cd ..
        
        # Check binary count (should be 6 platforms)
        BINARY_COUNT=$(find dist -name "dockerutilities-*" -type f | wc -l)
        echo "üì¶ Found $BINARY_COUNT binaries"
        
        if [ "$BINARY_COUNT" -ge 6 ]; then
          echo "‚úÖ All platform binaries created"
        else
          echo "‚ùå Expected 6 binaries, found $BINARY_COUNT"
          exit 1
        fi
        
        # Enhanced binary testing with comprehensive verification
        echo "üß™ Testing binary functionality across all platforms..."
        
        # Use the comprehensive verification script
        chmod +x scripts/verify-binaries.sh
        ./scripts/verify-binaries.sh release ./bin/dockerutilities ./dist
        
        # Platform-specific binary verification (file existence and basic checks)
        echo "üì¶ Platform-specific binary verification..."
        
        for platform_info in "${PLATFORMS[@]}"; do
          IFS=':' read -r binary_path platform_name <<< "$platform_info"
          
          if [[ -f "$binary_path" ]]; then
            echo "‚úÖ $platform_name binary exists"
            BINARY_SIZE=$(stat -c%s "$binary_path")
            echo "   Size: $BINARY_SIZE bytes"
          else
            echo "‚ùå $platform_name binary missing: $binary_path"
          fi
        done
        
        echo "üéâ Enhanced artifact verification completed!"
    
    - name: Prepare Docker configuration for Phase 4
      run: |
        echo "üê≥ Preparing Docker configuration for Phase 4..."
        
        # Create Docker build test script
        cat > scripts/test-docker-build.sh << 'EOF'
        #!/bin/bash
        # Docker build test script for Phase 4 preparation
        
        set -e
        
        echo "Testing Docker build process..."
        
        # Test multi-platform Docker build
        if command -v docker >/dev/null 2>&1; then
          echo "Building Docker image for testing..."
          
          # Build for current platform
          docker build -t dockerutilities:test .
          
          # Test the built image
          echo "Testing Docker image..."
          docker run --rm dockerutilities:test version || echo "Docker test failed"
          
          # Cleanup
          docker rmi dockerutilities:test || true
          
          echo "‚úÖ Docker build test completed"
        else
          echo "‚ö†Ô∏è Docker not available for testing"
        fi
        EOF
        
        chmod +x scripts/test-docker-build.sh
        echo "‚úÖ Docker test script created for Phase 4"
        
        # Create Docker configuration documentation
        cat > docs/docker-integration-plan.md << 'EOF'
        # Docker Integration Plan (Phase 4)
        
        ## Overview
        This document outlines the plan for integrating Docker image building into the GoReleaser release process.
        
        ## Current Status
        - GoReleaser Docker configuration is prepared in `.goreleaser.yml`
        - Multi-platform builds (linux/amd64, linux/arm64) are configured
        - GitHub Container Registry integration is ready
        
        ## Implementation Steps
        1. Enable Docker builds in GoReleaser configuration
        2. Configure GitHub Container Registry authentication
        3. Add Docker image testing and validation
        4. Implement multi-platform Docker builds
        5. Add Docker image security scanning
        
        ## Configuration
        - Images: `ghcr.io/smiller333/dockerutilities:{{ .Version }}` and `:latest`
        - Platforms: linux/amd64, linux/arm64
        - Registry: GitHub Container Registry
        
        ## Testing
        Use `scripts/test-docker-build.sh` to test Docker builds locally.
        EOF
        
        echo "‚úÖ Docker integration documentation created"
    
    - name: Create release summary
      run: |
        echo "üìã Release Summary"
        echo "=================="
        echo "Version: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Platforms: 6 (Linux/macOS/Windows AMD64/ARM64)"
        echo "Artifacts: $(find dist -name 'dockerutilities-*' -type f | wc -l) binaries"
        echo "Checksums: SHA256 verified"
        echo "Docker: Configuration prepared for Phase 4"
        echo ""
        echo "‚úÖ Milestone 2.2: Artifact Management completed!"
