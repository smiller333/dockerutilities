<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker Image Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-modal {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(2px);
        }
        
        .loading-modal .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100">
    <!-- Header -->
    <div class="bg-blue-600 text-white text-center py-4">
        <h1 class="text-2xl font-bold">Docker Image Viewer</h1>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto p-4 max-w-4xl">
        <!-- Analyze Image Section -->
        <div class="mb-6 bg-white shadow rounded-md p-4">
            <h3 class="text-lg font-medium mb-2 text-gray-800">Analyze Image</h3>
            <p class="text-sm text-gray-500 mb-2 italic">Note: If the image tag corresponds to an already analyzed ID, it will not be reprocessed.</p>
            <div class="flex items-center gap-2">
                <input
                    id="analyzeInput"
                    type="text"
                    placeholder="nginx:latest"
                    class="flex-1 p-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
                <button
                    id="analyzeBtn"
                    class="p-2 bg-gray-400 text-white rounded-md cursor-not-allowed opacity-50"
                    disabled
                >
                    Analyze
                </button>
            </div>
        </div>

        <h2 class="text-xl font-semibold mb-4 text-gray-800">Analyzed Images</h2>

        <!-- Filter Controls -->
        <div class="mb-4 flex flex-col gap-2">
            <input
                id="filterInput"
                type="text"
                placeholder="Filter by tag..."
                class="p-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
        </div>

        <!-- Content Area -->
        <div id="content">
            <div class="flex items-center justify-center py-8">
                <div class="loading-spinner"></div>
                <span class="ml-2 text-gray-600">Loading image summaries...</span>
            </div>
        </div>
    </div>

    <!-- Modal for detailed view -->
    <div id="detailModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-90vh overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b">
                <h2 id="modalTitle" class="text-xl font-semibold">Image Details</h2>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-4 max-h-96 overflow-y-auto">
                <pre id="jsonData" class="bg-gray-50 p-4 rounded text-sm overflow-x-auto"></pre>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal loading-modal">
        <div class="bg-white rounded-lg shadow-xl p-8 mx-4 text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Analyzing Image</h3>
            <p class="text-gray-600" id="loadingMessage">Please wait while we analyze the Docker image...</p>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex items-center justify-between p-4 border-b">
                <h2 id="confirmTitle" class="text-xl font-semibold">Confirm Action</h2>
                <button id="closeConfirmModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-4">
                <p id="confirmMessage" class="text-gray-600 mb-6"></p>
                <div class="flex justify-end gap-3">
                    <button id="confirmCancel" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-md transition-colors duration-200">
                        Cancel
                    </button>
                    <button id="confirmDelete" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md transition-colors duration-200">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex items-center justify-between p-4 border-b">
                <h2 id="resultTitle" class="text-xl font-semibold">Result</h2>
                <button id="closeResultModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-4">
                <div id="resultContent" class="flex items-center mb-4">
                    <div id="resultIcon" class="mr-3"></div>
                    <p id="resultMessage" class="text-gray-600"></p>
                </div>
                <div class="flex justify-end">
                    <button id="resultOk" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors duration-200">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let summaries = [];
        let currentSortField = 'analyzed_at';
        let currentSortOrder = 'desc';
        let currentFilter = '';

        // DOM elements
        const content = document.getElementById('content');
        const modal = document.getElementById('detailModal');
        const modalTitle = document.getElementById('modalTitle');
        const jsonData = document.getElementById('jsonData');
        const closeModal = document.getElementById('closeModal');
        const filterInput = document.getElementById('filterInput');
        const analyzeInput = document.getElementById('analyzeInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loadingModal = document.getElementById('loadingModal');
        const loadingMessage = document.getElementById('loadingMessage');
        
        // Confirmation modal elements
        const confirmModal = document.getElementById('confirmModal');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const closeConfirmModal = document.getElementById('closeConfirmModal');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmDelete = document.getElementById('confirmDelete');
        
        // Result modal elements
        const resultModal = document.getElementById('resultModal');
        const resultTitle = document.getElementById('resultTitle');
        const resultMessage = document.getElementById('resultMessage');
        const resultIcon = document.getElementById('resultIcon');
        const closeResultModal = document.getElementById('closeResultModal');
        const resultOk = document.getElementById('resultOk');
        
        // Store pending delete action
        let pendingDeleteAction = null;

        // Initialize the application
        async function init() {
            await loadSummaries();
            renderSummaries();
            setupEventListeners();
        }

        // Setup event listeners
        function setupEventListeners() {
            filterInput.addEventListener('input', (e) => {
                currentFilter = e.target.value;
                renderSummaries();
            });

            analyzeInput.addEventListener('input', (e) => {
                const hasValue = e.target.value.trim().length > 0;
                analyzeBtn.disabled = !hasValue;
                if (hasValue) {
                    analyzeBtn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
                    analyzeBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                } else {
                    analyzeBtn.classList.add('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
                    analyzeBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                }
            });

            analyzeBtn.addEventListener('click', handleAnalyzeImage);

            analyzeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !analyzeBtn.disabled) {
                    handleAnalyzeImage();
                }
            });

            closeModal.addEventListener('click', () => {
                modal.classList.remove('show');
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });

            // Confirmation modal event listeners
            closeConfirmModal.addEventListener('click', () => {
                confirmModal.classList.remove('show');
                pendingDeleteAction = null;
            });

            confirmCancel.addEventListener('click', () => {
                confirmModal.classList.remove('show');
                pendingDeleteAction = null;
            });

            confirmDelete.addEventListener('click', () => {
                confirmModal.classList.remove('show');
                if (pendingDeleteAction) {
                    executeDelete(pendingDeleteAction.imageId, pendingDeleteAction.imageTag);
                    pendingDeleteAction = null;
                }
            });

            confirmModal.addEventListener('click', (e) => {
                if (e.target === confirmModal) {
                    confirmModal.classList.remove('show');
                    pendingDeleteAction = null;
                }
            });

            // Result modal event listeners
            closeResultModal.addEventListener('click', () => {
                resultModal.classList.remove('show');
            });

            resultOk.addEventListener('click', () => {
                resultModal.classList.remove('show');
            });

            resultModal.addEventListener('click', (e) => {
                if (e.target === resultModal) {
                    resultModal.classList.remove('show');
                }
            });
        }

        // Handle analyze image functionality
        async function handleAnalyzeImage() {
            const imageTag = analyzeInput.value.trim();
            if (!imageTag) return;

            // Check if already exists
            if (summaries.some(summary => summary.image_tag.toLowerCase() === imageTag.toLowerCase())) {
                showResultModal('Already Analyzed', 'This image tag has already been analyzed.', 'error');
                return;
            }

            // Show loading modal
            loadingMessage.textContent = `Analyzing ${imageTag}...`;
            loadingModal.classList.add('show');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image_name: imageTag,
                        keep_temp_files: false,
                        force_pull: false
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Clear the input
                    analyzeInput.value = '';
                    
                    // Reload summaries to show the new analysis
                    await loadSummaries();
                    renderSummaries();
                    
                    // Hide loading modal
                    loadingModal.classList.remove('show');
                    
                    // Navigate to details page for the analyzed image
                    if (result.image_id) {
                        showDetails(result.image_id);
                    } else {
                        showResultModal('Success', 'Image analysis completed successfully!', 'success');
                    }
                } else {
                    // Hide loading modal before showing error
                    loadingModal.classList.remove('show');
                    showResultModal('Analysis Failed', result.error || 'Unknown error', 'error');
                }
            } catch (error) {
                // Hide loading modal before showing error
                loadingModal.classList.remove('show');
                showResultModal('Analysis Failed', error.message, 'error');
            }
        }

        // Handle delete info functionality
        async function deleteInfo(imageId, imageTag) {
            // Show confirmation modal instead of browser confirm
            confirmTitle.textContent = 'Delete Analysis';
            confirmMessage.textContent = `Are you sure you want to delete the analysis for "${imageTag}" (${imageId})?`;
            pendingDeleteAction = { imageId, imageTag };
            confirmModal.classList.add('show');
        }

        // Execute the actual delete operation
        async function executeDelete(imageId, imageTag) {
            try {
                const response = await fetch(`/api/info/${imageId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    // Reload summaries to reflect the deletion
                    await loadSummaries();
                    renderSummaries();
                    
                    // Show success result modal
                    showResultModal('Success', `Successfully deleted analysis for "${imageTag}"`, 'success');
                } else {
                    showResultModal('Error', `Failed to delete analysis: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showResultModal('Error', `Failed to delete analysis: ${error.message}`, 'error');
            }
        }

        // Show result modal with success or error message
        function showResultModal(title, message, type) {
            resultTitle.textContent = title;
            resultMessage.textContent = message;
            
            // Set icon based on type
            if (type === 'success') {
                resultIcon.innerHTML = '<div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>';
            } else {
                resultIcon.innerHTML = '<div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></div>';
            }
            
            resultModal.classList.add('show');
        }

        // Sort by field (called by clicking table headers)
        function sortBy(field) {
            if (currentSortField === field) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortOrder = 'asc';
            }
            renderSummaries();
        }

        // Load summaries from the API
        async function loadSummaries() {
            try {
                const response = await fetch('/api/summaries');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                summaries = await response.json();
            } catch (error) {
                showError(`Failed to load summaries: ${error.message}`);
            }
        }

        // Render summaries in the UI
        function renderSummaries() {
            if (summaries.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">No Image Summaries Found</h2>
                        <p class="text-gray-600 mb-4">No Docker image analysis results were found in the tmp directory.</p>
                        <p class="text-gray-600 mb-6">Run <code class="bg-gray-200 px-2 py-1 rounded">dockerutils analyze --image &lt;image-name&gt;</code> to create analysis results.</p>
                    </div>
                `;
                return;
            }

            const filteredAndSortedSummaries = getFilteredAndSortedSummaries();

            if (filteredAndSortedSummaries.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">No Matching Images</h2>
                        <p class="text-gray-600">No images match your current filter criteria.</p>
                    </div>
                `;
                return;
            }

            const tableRows = filteredAndSortedSummaries.map(summary => createTableRow(summary)).join('');
            
            content.innerHTML = `
                <div class="bg-white shadow rounded-md overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer hover:text-gray-700" onclick="sortBy('image_tag')">
                                    Tag <span class="inline-block ml-1">↑↓</span>
                                </th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer hover:text-gray-700" onclick="sortBy('image_id')">
                                    ID <span class="inline-block ml-1">↑↓</span>
                                </th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer hover:text-gray-700" onclick="sortBy('image_size')">
                                    Size <span class="inline-block ml-1">↑↓</span>
                                </th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer hover:text-gray-700" onclick="sortBy('architecture')">
                                    Arch <span class="inline-block ml-1">↑↓</span>
                                </th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer hover:text-gray-700" onclick="sortBy('analyzed_at')">
                                    Last Analyzed <span class="inline-block ml-1">↑↓</span>
                                </th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        ${tableRows}
                    </table>
                </div>
            `;
        }

        // Get filtered and sorted summaries
        function getFilteredAndSortedSummaries() {
            return summaries
                .filter(summary => 
                    summary.image_tag && summary.image_tag.toLowerCase().includes(currentFilter.toLowerCase())
                )
                .sort((a, b) => {
                    const fieldA = a[currentSortField];
                    const fieldB = b[currentSortField];
                    
                    if (currentSortField === 'image_size' || currentSortField === 'layer_count') {
                        const numA = Number(fieldA) || 0;
                        const numB = Number(fieldB) || 0;
                        return currentSortOrder === 'asc' ? numA - numB : numB - numA;
                    }
                    
                    const strA = String(fieldA || '').toLowerCase();
                    const strB = String(fieldB || '').toLowerCase();
                    return currentSortOrder === 'asc' 
                        ? strA.localeCompare(strB)
                        : strB.localeCompare(strA);
                });
        }

        // Format file size
        function formatSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Create a table row HTML
        function createTableRow(summary) {
            const imageSize = formatSize(summary.image_size);
            const analyzedAt = new Date(summary.analyzed_at).toLocaleString();
            const shortImageId = (summary.image_id || '').replace('sha256:', '').substring(0, 12);

            let rowHtml = `
                <tbody class="hover:bg-gray-50 transition-colors">
                    <tr class="cursor-pointer" onclick="showDetails('${shortImageId}')" title="Click to view detailed analysis">
                        <td class="px-4 py-2 text-sm text-gray-900">${summary.image_tag || 'Unknown'}</td>
                        <td class="px-4 py-2 text-sm text-gray-500">${shortImageId}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${imageSize}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${summary.architecture || 'Unknown'}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${analyzedAt}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">
                            <button 
                                onclick="event.stopPropagation(); deleteInfo('${shortImageId}', '${summary.image_tag || 'Unknown'}')" 
                                class="bg-red-500 hover:bg-red-600 text-white p-2 rounded transition-colors duration-200"
                                title="Delete this analysis"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>`;

            // Add source row if image_source is available
            if (summary.image_source) {
                rowHtml += `
                    <tr>
                        <td colspan="6" class="px-4 py-1 text-xs text-gray-400 italic border-t-0">Source: ${summary.image_source}</td>
                    </tr>`;
            }

            rowHtml += `</tbody>`;

            return rowHtml;
        }

        // Navigate to details page
        function showDetails(id) {
            window.location.href = `details.html?id=${id}`;
        }

        // Show error message
        function showError(message) {
            content.innerHTML = `
                <div class="text-center py-12">
                    <h2 class="text-xl font-semibold mb-4 text-red-600">Error</h2>
                    <p class="text-gray-600">${message}</p>
                </div>
            `;
        }

        // Format date to human readable format
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            try {
                return new Date(dateString).toISOString();
            } catch {
                return 'Unknown';
            }
        }

        // Start the application
        init();
    </script>
</body>
</html>
